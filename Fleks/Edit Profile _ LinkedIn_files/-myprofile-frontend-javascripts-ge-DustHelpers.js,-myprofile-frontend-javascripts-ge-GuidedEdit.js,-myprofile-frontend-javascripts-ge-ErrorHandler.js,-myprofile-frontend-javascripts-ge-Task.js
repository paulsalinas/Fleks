(function(){var k={},g=function(c,a,e,b){var d=null;b&&_.has(b,c)&&(d=dust.helpers.tap(b[c],a,e));return d},l=function(c,a,e){var b="",d=null,b="";if(g("type",c,a,e)){d={};d.type=a.stack.head.templateName+"-"+dust.helpers.tap(e.type,c,a);(b=g("label",c,a,e))&&(dust.i18n.cache.hasOwnProperty(a.templateName)&&dust.i18n.cache[a.templateName].hasOwnProperty(b))&&(d.label=dust.i18n.cache[a.templateName][b]);if(b=g("trk",c,a,e))d.trk=b;d.hide="true"===g("hide",c,a,e)}return d};_.extend(dust.helpers,{setGEButton:function(c,
a,e,b){(a=l(c,a,b))&&(k[a.type]=a);return c},geButton:function(c,a,e,b){var d=l(c,a,b),f={};if(b=g("type",c,a,b))b=a.stack.head.templateName+"-"+b,_.has(k,b)&&(f=k[b]),_.defaults(f,d);return f.hide?c:c.render(e.block,a.push(f))},listSplitter:function(c,a,e,b){var d=g("oList",c,a,b),f=g("splitSize",c,a,b)||1;b=[];var k=d.length,f=Math.floor(k/f),h=0;for(a.stack.head.lists=[];h<k;h++)h&&0===h%f&&(a.stack.head.lists=b,c=c.render(e.block,a),b=[]),d[h].originalIdx=h,b.push(d[h]);b.length&&(a.stack.head.lists=
b,c=c.render(e.block,a));return c}})})();(function(q){var h="/you/guidededit",k="/you/guidededit/prefill/url",l="/you/guidededit/prefill/nudge",m="/you/guidededit/prefill/resume",p={renderOnInit:!0,endpointOverride:!1},n={next:"/you/guided/actions/next",skip:"/you/guided/actions/skip",doesnotapply:"/you/guided/actions/doesnotapply",no:"/you/guided/actions/no",close:"/you/guided/actions/close",impression:"/you/guided/impression",yes:"/you/guided/actions/yes"},g={OPEN:"ge.open",CLOSE:"ge.close",NEW_TASK:"ge.new_task",NEW_CATEGORY:"ge.new_category"};
LI.define("GuidedEdit");LI.GuidedEdit=Fiber.extend(function(){return _.extend({init:function(b,a){a=a||{};_.defaults(a,p);this._$el=b;this._config=a;this._tasks=[];this._currentTask=0;this._allFormData={};this._globalFields={};this._pendingData={};this._queuedRequests=[];this._queuedTasks=[];this._tasksWaitingSubmission=0;this._queueProcessing=!1;this._errorQueue=[];this._dispatchingErrors=!1;this._$dfrFetch=$.Deferred();this._$dfrQueue=$.Deferred();this._versionTagRetry=!1;!1!==a.endpointOverride&&
(h=a.endpointOverride,m=l=k=void 0);a.renderOnInit&&this._render();Fiber.mixin(LI.GuidedEdit.Task,LI.GuidedEdit.ErrorHandler)},_render:function(){var b=this,a=$.Deferred();dust.render("templates/ge/guided_edit",{},function(c,d){c||(b._$el.html(d),b._initModule(),a.resolve())});return a.promise()},_initModule:function(){var b=this._$el,a=this._config.urlParams||{};this._$ge=b.find(".guided-edit");this._$form=b.find(".form");b.on("click",".close",_.bind(this._handleCloseClick,this));_.has(this._config,
"forceSection")?a.forceSection=this._config.forceSection:_.has(a,"categoryName")&&(a.forceSection=a.categoryName);delete a.categoryName;!_.has(this._config,"forcePrefill")||"url"!==this._config.forcePrefill&&"nudge"!==this._config.forcePrefill||(a.prefill=this._config.forcePrefill);(b=$.fn.Profile)&&b.bind(b.EVENTS.TIMESTAMP_CHANGED,$.proxy(this._handleProfileVersionTagChanged,this));this._fetchTasks(a)},_fetchTasks:function(b){var a=this,c=h,d;b=b||{};d=!!b.prefill;_.has(b,"prefill")&&("url"===b.prefill?
c=k:"nudge"===b.prefill?c=l:"resume"===b.prefill&&(c=m));a._allFormData={};a._tasks=[];a._globalFields={};$.ajax({url:c,data:b,dataType:"json"}).done(function(b){a._loadTasks(b);a._$dfrFetch.resolve()}).fail(function(c,f,r){a.hide();404!==c.status?d?(a._handleServerError(a._parseResponseTextToJson(c)),delete b.prefill,a._fetchTasks(b)):a._$dfrFetch.fail():a._$dfrFetch.resolve()})},_loadTasks:function(b){var a=this;_.has(b,"tasks")?(_.has(b,"sessionData")&&_.extend(this._globalFields,b.sessionData),
_.each(b.tasks,function(b){a._tasks.push(new LI.GuidedEdit.Task.Loader(b.templateName,b,a))}),1<a._tasks.length&&a._tasks.sort(function(a,b){return a.task.order<b.task.order?-1:1}),a._currentTask=-1,a._nextTask()):a.hide()},tasksLoaded:function(){return this._$dfrFetch.promise()},_loadTask:function(b){var a=this._tasks,c=$.Deferred(),d=this;if(_.has(a[b],"$dfr"))return a[b].$dfr;a[b].preload().done(function(e){a[b]=new e(d._$form,{task:a[b].task,manager:d});a[b].$dfr=c;c.resolve()});return a[b].$dfr=
c},_nextTask:function(b){var a=this,c=++a._currentTask,d=function(){a._tasks[c].shouldDisplay()?(b&&a._tasks[c].addTaskData(b),a._jumpToTask(c),c+1<a._tasks.length&&a._loadTask(c+1)):a._nextTask(b)};c<a._tasks.length?a._tasks[c].isLoaded?d():a._loadTask(c).done(d):a._nextCategory()},_nextCategory:function(){this._queueProcessing&&this._queuedRequests.length?this._queuedRequests[0].$dfr.promise().done(_.bind(this._nextCategory,this)):this._errorQueue.length?this._dispatchErrors():(this._fetchTasks(),
this.trigger(g.NEW_CATEGORY))},_jumpToTask:function(b){var a=this,c=function(c){c.render().done(function(){a._track(a._tasks[b],"impression");a.show();a.setLoading(!1);a.trigger(g.NEW_TASK,c)}).fail(function(){a.displayGenericError();a.setLoading(!1)})};b<a._tasks.length&&(a._tasks[b].isLoaded?c(a._tasks[b]):a._loadTask(b).done(function(){c(a._tasks[b])}),a._currentTask=b)},_enqueueTaskSubmit:function(b,a){this._queuedRequests.push({data:b,endpoint:a,tasks:this._queuedTasks,$dfr:$.Deferred()});this._queuedTasks=
[];return this._executeSubmitQueue()},_executeSubmitQueue:function(b){var a=!!b,c=b||this._queuedRequests.shift(),d=this,e="";if(!d._queueProcessing||a)d._queueProcessing=!0,a={},_.extend(a,c.data,d._globalFields),b="taskData[?].name".replace("?",d._currentTask),_.has(a,b)||_.has(a,"taskData[0].name"),$.ajax({url:c.endpoint,type:"POST",dataType:"json",data:a}).done(function(a){_.has(a,"idFieldName")&&(e=a.idFieldName,d._globalFields[e]=a[e]);_.has(a,"profileVersionTag")&&(d._globalFields.profileVersionTag=
a.profileVersionTag);d._requestComplete(c.$dfr,!0,a,c.tasks)}).fail(function(a){var b=d._parseResponseTextToJson(a);d._shouldRetryRequest(b)?(d._versionTagRetry=!0,d._handleProfileVersionTagChanged(null,"profileVersionTag").done(function(){d._executeSubmitQueue(c)}).fail(function(){d._handleServerError(b);d._requestComplete(c.$dfr,!1)})):(d._handleServerError(b),d._requestComplete(c.$dfr,!1))});return c.$dfr.promise()},_parseResponseTextToJson:function(b){var a;try{a=JSON.parse(b.responseText)}catch(c){}return a},
displayGenericError:function(b){LI.injectAlert({message:LI.GuidedEdit.ErrorHandler.renderError(b||"validation.error.unknown"),type:"error",dismissable:!0,animate:!0});this.setLoading(!1)},_shouldRetryRequest:function(b){return b&&_.has(b,"error")&&"error.versionTag"===b.error.code&&!this._versionTagRetry},_handleServerError:function(b){var a=this,c=!1;b&&"object"===typeof b?_.has(b,"error")?a.displayGenericError("validation."+b.error.code):b.formErrors?_.each(b.formErrors,function(b,e){var f=a._getTaskById(e);
f?(a._errorQueue.push({task:f,errors:b}),c|=f.required):a.displayGenericError()}):a.displayGenericError():a.displayGenericError();c&&a._dispatchErrors()},_dispatchErrors:function(){var b=this._errorQueue.shift();"object"===typeof b?(this._dispatchingErrors=!0,b.task.render(),b.task.handleError(b.errors),this.setLoading(!1)):this._dispatchingErrors=!1;return this._dispatchingErrors},_requestComplete:function(b,a,c,d){this._versionTagRetry=this._queueProcessing=!1;a?(d&&d.forEach(function(a){a.submitComplete()}),
b.resolve(c)):b.reject();0<this._queuedRequests.length?this._executeSubmitQueue():(this._$dfrQueue.resolve(),this._$dfrQueue=$.Deferred())},_track:function(b,a){var c;_.has(n,a)?c=$.ajax({url:n[a],type:"POST",dataType:"json",data:_.extend({csrfToken:this._$el.find('input[name\x3d"csrfToken"]').val(),taskId:b.taskId,taskName:b.taskName},this._globalFields)}):(c=$.Deferred(),c.resolve(),c=c.promise());return c},_addTaskDataToRequest:function(b,a,c){var d=RegExp("taskData[?].id".replace("[","\\[").replace("]",
"\\]").replace("?","[\\d]")),e=!0;_.each(c,function(b,c){d.test(c)&&a.taskId===b&&(e=!1)});e&&(c["taskData[?].id".replace("?",b)]=a.taskId,c["taskData[?].name".replace("?",b)]=a.taskName)},_getTaskById:function(b){return _.find(this._tasks,function(a){return a.taskId===b})},_handleProfileVersionTagChanged:function(b,a,c){if("profileVersionTag"===a)if(c)this._globalFields.profileVersionTag=c,b=$.Deferred(),b.resolve(c),b=b.promise();else{var d=this;b=$.ajax({url:"/you/guided/versionTag"}).done(function(a){d._globalFields.profileVersionTag=
a})}else b=$.Deferred(),b.reject(),b=b.promise();return b},_handleCloseClick:function(b){b=this._tasks;var a=this._currentTask;a<b.length&&(this._track(b[a],"close"),_.has(b[a],"closeAllErrors")&&b[a].closeAllErrors());this.hide()},taskSubmit:function(b,a,c){var d=this,e={},f=function(a){var c=!0;d._dispatchingErrors&&(c=!d._dispatchErrors());c&&(_.extend(d._allFormData,a,b),d._nextTask(d._allFormData))};a.closeAllErrors();_.extend(d._pendingData,b);d._addTaskDataToRequest(d._tasksWaitingSubmission,
a,d._pendingData);d._tasksWaitingSubmission++;this._queuedTasks.push(a);a.action?(e=d._enqueueTaskSubmit(d._pendingData,a.action),a.required||d._currentTask==d._tasks.length-1?(d.setLoading(!0),e.done(function(a){d._pendingData={};d._tasksWaitingSubmission=0;f(a)}),!a.required&&1<d._tasks.length?e.fail(f):e.fail(function(){d.setLoading(!1)})):(d._pendingData={},d._tasksWaitingSubmission=0,f())):(this._track(a,c),f());return e},taskSkip:function(b,a){var c=this;b.closeAllErrors();this.setLoading(!0);
return c._track(b,a).done(function(){b.required?c._fetchTasks():c._nextTask(c._allFormData)})},show:function(){var b=this,a=$.Deferred();this._$ge.is(":visible")?a.resolve():this._$ge.stop().slideDown({duration:350,queue:!1}).promise().done(function(){b.trigger(g.OPEN);a.resolve()});return a.promise()},hide:function(){this._$ge.hide();this.trigger(g.CLOSE)},setLoading:function(b){this._$ge.toggleClass("loading",b);this._$ge.find("input,select").prop("readonly",b);this._$ge.find("button").prop("disabled",
b)}},LI.Events)});LI.GuidedEdit.EVENTS=g})();(function(m){LI.define("LI.GuidedEdit.ErrorHandler");LI.GuidedEdit.ErrorHandler=function(b){return{handleError:function(e){var a=this,d=!1,c=this._$el.find('button[type\x3d"submit"]'),b=!1;c.prop("disabled",!0).attr("disabled",!0);a.closeAllErrors().done(function(){_.each(e,function(d,e){var c=a._$el.find('[name\x3d"'+e+'"]'),k=e.replace(/\./g,"-");c.length&&"hidden"!==c.attr("type")&&!b?a._errorCards.push({errorCard:new LI.Tooltip.ErrorCard(c,{direction:"bottom",tooltipContentID:k.replace("[","\\[").replace("]",
"\\]")+"-error",type:"hovercard"}),$input:c,errorFieldIdPrefix:k,errors:d}):b=!0});b?(LI.injectAlert({message:LI.GuidedEdit.ErrorHandler.renderError("validation.error.unknown"),type:"error",dismissable:!0,animate:!0}),a._errorCards=[],c.prop("disabled",!1).attr("disabled",!1)):a._errorCards.length&&(_.each(a._errorCards,function(c){var e=c.errorCard,b=c.$input;a._renderErrorTooltip(c.errorFieldIdPrefix,c.errors);e.open();d||(b.focus(),d=!1)}),a._$el.on("keyup.error change.error",_.bind(a.closeAllErrors,
a,!0)))})},closeAllErrors:function(e){var a=0,d=this,c=d._$el.find('button[type\x3d"submit"]'),b=d._errorCards?d._errorCards.length:0,f=b,g=$.Deferred(),h=function(){f--;0>=f&&(d._$el.off("keyup.error change.error"),g.resolve())};if(b)for(;a<b;a++)d._errorCards[a].errorCard.close().done(h);else h();e&&c.prop("disabled",!1).attr("disabled",!1);d._errorCards=[];return g.promise()},_renderErrorTooltip:function(b,a){for(var d=this,c=0,l=a.length;c<l;c++)a[c]=LI.GuidedEdit.ErrorHandler.renderError("validation."+
a[c].code,a[c]);dust.render("templates/common/error_tooltip",{fieldName:b,errors:a},function(a,c){a||(d._$el.find("#"+b+"-error").remove(),d._$el.find(".errors").append(c))})}}};_.extend(LI.GuidedEdit.ErrorHandler,{_errorStrings:{},registerErrorString:function(b,e,a){var d=LI.GuidedEdit.ErrorHandler._errorStrings;_.isObject(b)?_.extend(d,b):d[b]={template:e,i18nKey:a}},renderError:function(b,e){var a=null,d=null,c="__i18n__";_.has(LI.GuidedEdit.ErrorHandler._errorStrings,b)&&(d=LI.GuidedEdit.ErrorHandler._errorStrings[b],
c+=d.template+"__"+d.i18nKey,_.has(dust.i18n.cache,d.template)&&_.has(dust.i18n.cache[d.template],d.i18nKey)?a=dust.i18n.cache[d.template][d.i18nKey]:_.has(dust.cache,c)&&dust.render(c,e,function(b,c){b||(a=c)}));a||(a=LI.GuidedEdit.ErrorHandler.renderDefaultError(e));return a},registerDefaultErrorString:function(b,e){LI.GuidedEdit.ErrorHandler.registerErrorString("DEFAULT_ERROR_STRING",b,e)},renderDefaultError:function(b){var e=LI.GuidedEdit.ErrorHandler;return _.has(e._errorStrings,"DEFAULT_ERROR_STRING")?
e.renderError("DEFAULT_ERROR_STRING",b):null}});LI.define("Tooltip.ErrorCard");LI.Tooltip.ErrorCard=LI.Tooltip.extend(function(b){return{attachEventListeners:function(){},_attachTooltipListeners:function(){},_open:function(){this.isMouseoverTrigger=!0;return b._open.call(this)},_close:function(){this.isMouseoverTooltip=this.isMouseoverTrigger=!1;return b._close.call(this)}}})})();(function(h){LI.define("GuidedEdit.Task");LI.GuidedEdit.Task=window.Fiber.extend(function(h){return{init:function(a,b){this._$el=a;this._config=b;_.defaults(this,b.task);this._manager=this._config.manager;this.isLoaded=!0},render:function(){var a=this,b=$.Deferred();this._$stashedDom?(a._$el.empty().append(this._$stashedDom),a.renderComplete(),b.resolve()):dust.render("templates/ge/"+this.templateName,this._config.task,function(c,d){c?b.reject(c):(a._$el.html(d),a.renderComplete(),b.resolve())});
return b.promise()},shouldDisplay:function(){var a=!0,b=this._manager._allFormData,c=null,d={},e="",f=d="",g="";if((d=this._config.task.requiredDataField)&&d.key&&d.value)for(c in e=d.key.toLowerCase(),d=d.value.toLowerCase(),a=!1,b)b.hasOwnProperty(c)&&(f=c.replace(/(\[[\d]+\]|[\d]+)/,"").toLowerCase(),g=b[c].toLowerCase(),e===f&&d===g&&(a=!0));return a},getTaskData:function(){return this._config.task},addTaskData:function(a){_.defaults(this._config.task,a)},validate:function(){return!0},renderComplete:function(){this._$form=
this._$el.find("form.ge-form");this._$form.on("submit",_.bind(this._formSubmit,this)).on("click",'.ge-buttons button[type\x3d"button"]',_.bind(this._handleButtonClick,this))},submitComplete:function(a){var b=$.fn.Profile;b&&(a=a||LI.GuidedEdit.TaskSection.getUpdateSections(this._config.task.taskName))&&b.fire(b.EVENTS.REFRESH_SECTIONS,[a])},clearLocalStorageSet:function(a){Object.keys(localStorage).forEach(function(b){b.match(a)&&localStorage.removeItem(b)})},_formSubmit:function(a){var b=this._$el.find('button[type\x3d"submit"]').data("trk"),
c=!1;a.preventDefault();this.validate()&&(this._stash(),this._manager.taskSubmit(this._getFormData(),this,b),c=!0);return c},_handleButtonClick:function(a){a=$(a.currentTarget).data("trk");this._stash();this._manager.taskSkip(this,a)},_getFormData:function(){var a={};_.each(this._$form.serializeArray(),function(b){a[b.name]=b.value.replace(/\r?\n/g,"\n")});return a},_stash:function(){this._$stashedDom=this._$el.clone(!0)}}})})();